# 2025121714 GeoHPEM 软件架构设计（底层平台，类 PLAXIS 2D）

> 目标：构建一个可扩展的“工程/前后处理平台 + 求解编排器”。数值求解（含本构、HPEM、耦合等）由外部 **solver Python 包**提供，作为 submodule 集成；平台通过**稳定的数据契约（JSON + NPZ）**与 solver 交换数据，并提供 GUI（PySide6）用于建模、求解、可视化与对标。

## 1. 总体定位与边界

### 1.1 平台负责什么
- **前处理**：几何交互绘制 → 网格化（pygmsh/gmsh）与“导入现成网格”（gmsh/meshio 等）两条入口；集合（sets）管理；材料/边界/荷载/阶段赋值。
- **求解编排**：将工程数据整理为标准 `SolveRequest`（`request.json + mesh.npz`），调用 solver 包，处理进度/取消/日志。
- **结果管理与后处理**：统一结果容器（registry + NPZ 数组），派生量计算、云图/剖面/时程、导出（VTK/CSV/图片等）。
- **工程化**：工程文件版本迁移、可复现（保存 request/solver 版本/随机种子/机器信息）、回归对比、诊断日志。

### 1.2 平台不负责什么
- 不实现本构与核心数值算法（由 solver 团队负责）。
- 不强绑定某一种 solver；通过能力握手与契约版本兼容来解耦。

## 2. 核心设计原则

1. **契约先行（Contract-First）**：先定输入/输出结构与版本演进策略，GUI/后处理围绕契约构建。
2. **最小耦合**：平台仅依赖 solver 的稳定入口（`capabilities()` + `solve()`），不依赖其内部类结构。
3. **可扩展多物理**：平台能表达静力/动力/渗流/固结/耦合的“配置与数据”，但 solver 决定实际求解与可用特性。
4. **结果可发现（Discoverable Results）**：结果项通过 registry 描述；GUI 不写死字段清单，支持 solver 增加更多输出。
5. **可复现与可对标**：一次求解应可完整复现；保存求解输入、solver 版本、输出与诊断信息，便于对标 PLAXIS 或自研方法。

## 3. 分层架构（建议）

```
┌──────────────────────────────────────────────────────────┐
│ GUI (PySide6)                                             │
│ - 项目树/属性面板/视图/运行监视/后处理面板                │
└───────────────▲───────────────────────────────▲──────────┘
                │                               │
┌───────────────┴──────────────┐   ┌────────────┴──────────┐
│ Application / Use Cases       │   │ Post / Visualization   │
│ - 工作流：建模→阶段→求解→结果 │   │ - registry 驱动云图/曲线│
└───────────────▲──────────────┘   └────────────▲──────────┘
                │                               │
┌───────────────┴──────────────┐   ┌────────────┴──────────┐
│ Contract & IO                 │   │ Solver Adapter         │
│ - request/result schema        │   │ - import solver 包      │
│ - JSON+NPZ (de)serialize       │   │ - 进度/取消/异常映射     │
└───────────────▲──────────────┘   └────────────▲──────────┘
                │                               │
┌───────────────┴───────────────────────────────┴──────────┐
│ Domain Model                                                 │
│ - Project/Geometry/Mesh/Sets/Stage/BC/Load/Material/ResultRef │
└──────────────────────────────────────────────────────────────┘
```

## 4. Solver 对接约定（Contract v0.1）

### 4.1 solver 包必须提供的 API（最小集）

- `capabilities() -> dict`
  - 返回：支持的分析类型（static/dynamic/seepage/consolidation/…）、字段（u/p/T…）、单元类型、材料模型名、可输出结果名、支持的契约版本范围等。
- `solve(request: dict, mesh: dict, callbacks: Optional[dict] = None) -> tuple[result_meta: dict, result_arrays: dict]`
  - `request` 对应 `request.json` 的解析对象；
  - `mesh` 对应 `mesh.npz` 的解析对象（数组字典）；
  - `callbacks`（可选）：
    - `on_progress(p: float, message: str, stage_id: str, step: int)`：进度回调
    - `should_cancel() -> bool`：取消检查
    - `on_log(level: str, message: str)`：日志回调

> 说明：平台同时支持“纯内存调用”与“落盘可复现”的两种形态；两者数据结构一致。

### 4.2 输入文件：`request.json + mesh.npz`

#### `request.json`（可读、可版本化）
- `schema_version`: `"0.1"`
- `unit_system`: 统一单位体系声明（例如 `{"force":"kN","length":"m","time":"s"}`）
- `model`: `{"dimension":2, "mode":"plane_strain|axisymmetric", "gravity":[0,-9.81]}`
- `materials`: `{material_id: {"model_name": "...", "parameters": {...}}}`
- `assignments`: 将 `element_set` 映射到 `material_id`（及可选的场参数）
- `stages`: 阶段列表（MVP 先支持最常用子集）
  - `analysis_type`: `static | dynamic | seepage_transient | consolidation_u_p`
  - `time`: 静力可为空；其余包含 `t_end, dt, integrator`
  - `activate/deactivate`: 施工阶段开关（元素集/边界集/荷载集）
  - `bcs`：按字段分组（`u` 位移、`p` 孔压），支持 `dirichlet/neumann/robin`
  - `loads`：体力/面力/节点力/基底加速度时程/水头或流量边界（以引用集合 + 参数表表达）
- `output_requests`: 输出请求（名称、位置、频率）

#### `mesh.npz`（高效数组）
建议采用“分块 + 显式命名”的简单约定：
- `points`: `(N,2)` float64
- `cells_tri3`: `(M,3)` int32（可选更多类型，如 `cells_quad4`）
- 集合：
  - `node_set__NAME`: int32 节点索引数组
  - `elem_set__NAME__tri3`: int32 单元索引数组（分单元类型存）
  - `edge_set__NAME`: `(K,2)` int32 边界边（用于面力/水头边界）

> 集合命名使用 ASCII；展示名可在 `request.json` 另存 `labels`（可选）。

### 4.3 输出文件：`result.json + result.npz`

#### `result.json`（状态 + 结果索引 registry）
- `schema_version`: `"0.1"`
- `status`: `success|failed|canceled`
- `solver_info`: solver 包版本、git hash、运行环境摘要
- `stages`: 每阶段的收敛信息、步数、时间轴
- `warnings/errors`: 结构化消息列表（含错误码）
- `registry`: 结果项清单（GUI 以此动态生成可视化）
  - `name`：如 `u`, `p`, `stress`, `strain`, `reaction`, `energy`, …
  - `location`: `node|element|ip|global|history`
  - `shape`: `scalar|vector2|vector3|symtensor2|...`
  - `unit`
  - `npz_pattern`: 对应 `result.npz` 键名模式（见下）

#### `result.npz`（结果数组）
键名建议：
- `nodal__u__step000010`: `(N,2)` 或 `(N,3)`
- `nodal__p__step000010`: `(N,)`
- `ip__stress__step000010`: `(nip_total, ncomp)` 或分单元块存

MVP 输出建议（先做重要项）：
- 位移 `u`、孔压 `p`
- 应力/应变（element 或 ip 任一，优先 ip）
- 反力（global 或 nodal）
- 平衡残差与收敛指标（history/global）

派生量（如 `u_mag`、主应力、von Mises）可由：
- solver 直接输出；或
- 平台在 `post` 层根据基础量计算并缓存。

## 5. 里程碑（建议）

### M0：契约与闭环（平台骨架）
- `SolveRequest/SolveResult` 的 JSON+NPZ 读写与基本校验
- solver adapter：可 import submodule 并调用 `solve()`
- 一个 `fake solver`：用于端到端联调（返回占位结果）
- CLI：导出/运行/查看 registry（为 GUI 开发打底）

### M1：前处理 MVP
- 网格导入（gmsh/meshio）+ 基本集合生成
- pygmsh 网格化（矩形/多边形+边界物理组）
- 材料/边界/荷载/阶段最小编辑能力（先 CLI/后 GUI）

### M2：GUI MVP（PySide6）
- 项目树 + 属性面板（编辑 materials/sets/stages）
- 求解运行面板（进度、日志、取消）
- 云图（应力/应变/孔压）+ 剖面线 + 时程曲线（registry 驱动）

### M3：工程化与对标
- 工程文件打包、版本迁移、求解可复现
- 回归对比工具（同一输入不同 solver/版本的结果对比）
- 批处理与报告导出

## 6. 目录结构建议（实现侧）

建议采用 `src/` 布局：

```
GeoHPEM_NEW/
  docs/
  examples/
  src/geohpem/
    contract/
    domain/
    mesh/
    solver_adapter/
    post/
    gui/
    cli.py
  pyproject.toml
  README.md
```

## 7. 对 GeoHPEM_reference 的继承与改造建议

`GeoHPEM_reference/src/solver/FEMSimulation.py` 中值得保留的“工程思路”：
- 分步（step）概念与回调 `on_frame`（利于边算边看）
- 输出尽量完整的状态与结果（利于对标）

但要避免的结构问题（本项目将改为解耦架构）：
- 将网格生成、求解、VTK 导出、耦合逻辑写在同一类中导致不可维护
- 直接在 solver 里操纵 UI/模型对象导致边界不清

本项目将以 `Contract + Adapter + Registry` 方式重构接口：平台与 solver 之间只通过稳定契约交互。

